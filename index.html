<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korku Hikayeleri Forumu</title>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1f 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        nav {
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 2px solid #8b0000;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
        }
        .logo {
            font-family: 'Creepster', cursive;
            font-size: 1.8rem;
            color: #ff4444;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #8b0000;
            cursor: pointer;
        }
        .nav-menu {
            display: flex;
            gap: 2rem;
            list-style: none;
            flex-grow: 1;
            justify-content: center;
        }
        .nav-menu a {
            color: #e0e0e0;
            text-decoration: none;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }
        .nav-menu a:hover { color: #ff9999; }
        .btn {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.3), rgba(139, 0, 0, 0.3));
            border: 1px solid #8b0000;
            color: #ff9999;
            padding: 0.7rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
        }
        .btn:hover {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.5), rgba(139, 0, 0, 0.5));
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }
        .btn-secondary {
            background: rgba(100, 150, 255, 0.2);
            border-color: #66ccff;
            color: #66ccff;
        }
        .page { display: none; }
        .page.active { display: block; }
        .hero {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, rgba(20, 10, 20, 0.9), rgba(40, 20, 40, 0.9));
            margin: 2rem;
            border: 1px solid #8b0000;
            border-radius: 12px;
        }
        .hero h1 { font-size: 3rem; color: #ff9999; margin-bottom: 1rem; }
        .hero p { color: #888; font-size: 1.2rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .stories-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem;
        }
        .story-card {
            background: linear-gradient(135deg, rgba(20, 10, 20, 0.9), rgba(40, 20, 40, 0.9));
            border: 1px solid #8b0000;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .story-card:hover { box-shadow: 0 0 20px rgba(139, 0, 0, 0.5); }
        .story-title { font-size: 1.3rem; color: #ff9999; margin-bottom: 0.8rem; }
        .story-preview { color: #d0d0d0; font-size: 0.9rem; margin-bottom: 1rem; }
        .story-meta { color: #888; font-size: 0.85rem; margin-bottom: 1rem; }
        .story-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .action-btn {
            background: rgba(100, 50, 100, 0.3);
            border: 1px solid #8b0000;
            color: #ff9999;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        .action-btn:hover { background: rgba(100, 50, 100, 0.5); }
        .filter-row {
            display: flex;
            gap: 1rem;
            margin: 2rem;
            flex-wrap: wrap;
        }
        .filter-row input,
        .filter-row select {
            background: rgba(50, 50, 50, 0.9);
            border: 1px solid #8b0000;
            color: #e0e0e0;
            padding: 0.8rem;
            border-radius: 6px;
            font-family: 'Cinzel', serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: linear-gradient(135deg, rgba(20, 10, 20, 0.95), rgba(40, 20, 40, 0.95));
            border: 1px solid #8b0000;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; color: #ff9999; margin-bottom: 0.5rem; }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            background: rgba(50, 50, 50, 0.9);
            border: 1px solid #8b0000;
            color: #e0e0e0;
            padding: 0.8rem;
            border-radius: 6px;
            font-family: 'Cinzel', serif;
        }
        footer {
            background: rgba(10, 10, 10, 0.95);
            border-top: 2px solid #8b0000;
            padding: 2rem;
            text-align: center;
            color: #888;
            margin-top: 3rem;
        }
        @media (max-width: 768px) {
            nav { flex-direction: column; gap: 1rem; }
            .nav-menu { flex-direction: column; gap: 0.5rem; display: none; }
            .nav-menu.mobile-open { display: flex; }
            .stories-section { grid-template-columns: 1fr; margin: 1rem; }
            .filter-row { flex-direction: column; margin: 1rem; }
            .hero h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="logo" onclick="showPage('home')"><i class="fas fa-ghost"></i> Korku Forumu</div>
        <ul class="nav-menu" id="mainMenu">
            <li><a href="#" onclick="showPage('home'); resetFilters(); return false;">Ana Sayfa</a></li>
            <li><a href="#" onclick="setSortFilter('newest'); return false;">En Yeni</a></li>
            <li><a href="#" onclick="setSortFilter('popular'); return false;">En Pop√ºler</a></li>
            <li><a href="#" onclick="setSortFilter('mostCommented'); return false;">En √áok Yorum</a></li>
        </ul>
        <button class="btn btn-secondary" id="hamburgerBtn" style="display: none;" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </button>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div id="userDisplay" style="color: #ff9999;"></div>
            <button class="btn" id="authBtn" onclick="toggleAuth()">Giri≈ü Yap</button>
            <button class="btn" id="profileBtn" style="display: none;" onclick="showUserProfile()"><i class="fas fa-user"></i> Profil</button>
            <button class="btn btn-secondary" id="logoutBtn" style="display: none;" onclick="logout()">√áƒ±kƒ±≈ü</button>
            <button class="btn btn-secondary" id="addStoryBtn" style="display: none;" onclick="showAddStoryModal()"><i class="fas fa-plus"></i> Hikaye</button>
            <button class="btn btn-secondary" id="libraryBtn" style="display: none;" onclick="showPage('library')"><i class="fas fa-bookmark"></i> K√ºt√ºphane</button>
            <button class="btn btn-secondary" id="chatBtn" style="display: none;" onclick="showPage('chat')"><i class="fas fa-comments"></i> Sohbet</button>
        </div>
    </nav>

    <!-- ANA SAYFA -->
    <div id="home" class="page active">
        <div class="hero">
            <h1>üî¥ Korku Hikayeleri Forumu üî¥</h1>
            <p>Karanlƒ±k ve gerilim dolu hikayelerin bulu≈ütuƒüu yer...</p>
        </div>
        <div class="filter-row">
            <input type="text" id="searchInput" placeholder="Ara..." onkeyup="handleSearchInput()">
            <select id="categoryFilter" onchange="filterStories()">
                <option value="">T√ºm Kategoriler</option>
                <option value="Kƒ±sa Hikaye">Kƒ±sa Hikaye</option>
                <option value="Uzun Hikaye">Uzun Hikaye</option>
                <option value="√úrk√ºt√ºc√º">√úrk√ºt√ºc√º</option>
                <option value="Gizemli">Gizemli</option>
                <option value="Psikiyatrik">Psikiyatrik</option>
            </select>
            <select id="sortFilter" onchange="filterStories()">
                <option value="newest">En Yeni</option>
                <option value="popular">En Pop√ºler</option>
                <option value="mostCommented">En √áok Yorum</option>
            </select>
            <button class="btn" onclick="resetFilters()"><i class="fas fa-refresh"></i> Sƒ±fƒ±rla</button>
        </div>
        <div class="stories-section" id="storiesContainer"></div>
    </div>

    <!-- HIKAYE DETAY -->
    <div id="storyDetail" class="page">
        <div class="container">
            <button class="btn btn-secondary" onclick="showPage('home')"><i class="fas fa-arrow-left"></i> Geri</button>
            <h1 id="detailTitle" style="color: #ff9999; margin: 2rem 0;"></h1>
            <div style="color: #888; margin-bottom: 1rem;">
                <span>üë§ <span id="detailAuthor"></span></span> | 
                <span>üìÖ <span id="detailDate"></span></span> | 
                <span>üè∑Ô∏è <span id="detailCategory"></span></span>
            </div>
            <div id="detailContent" style="color: #d0d0d0; line-height: 1.8; margin: 2rem 0;"></div>
            <div style="display: flex; gap: 1rem; margin: 2rem 0;">
                <button class="action-btn" onclick="app?.toggleLikeStory()"><i class="fas fa-heart"></i> <span id="likeCount">0</span> Beƒüeni</button>
                <button class="action-btn"><i class="fas fa-comments"></i> <span id="commentCount">0</span> Yorum</button>
            </div>
            <div id="commentsSection">
                <h3 style="color: #ff9999; margin: 2rem 0;">Yorumlar</h3>
                <div id="commentForm" style="display: none; margin-bottom: 2rem;">
                    <textarea id="commentText" rows="3" placeholder="Yorumunuzu yazƒ±n..." style="width: 100%; background: rgba(50, 50, 50, 0.9); border: 1px solid #8b0000; color: #e0e0e0; padding: 1rem; border-radius: 6px;"></textarea>
                    <button class="btn" style="margin-top: 1rem;" onclick="addComment()"><i class="fas fa-paper-plane"></i> G√∂nder</button>
                </div>
                <div id="commentContainer"></div>
            </div>
        </div>
    </div>

    <!-- K√úT√úPHANE -->
    <div id="library" class="page">
        <div class="hero" style="margin: 2rem;">
            <h1><i class="fas fa-bookmark"></i> Beƒüenilen Hikayeler</h1>
        </div>
        <div class="stories-section" id="libraryContainer"></div>
    </div>

    <!-- CHAT -->
    <div id="chat" class="page">
        <div class="hero" style="margin: 2rem;">
            <h1><i class="fas fa-comments"></i> Genel Sohbet</h1>
        </div>
        <div class="container" style="max-width: 900px;">
            <div id="chatMessages" style="background: rgba(10, 10, 10, 0.8); border: 1px solid #8b0000; border-radius: 8px; padding: 1rem; height: 400px; overflow-y: auto; margin-bottom: 1rem;"></div>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="chatInput" placeholder="Mesajƒ±nƒ±z..." style="flex: 1; background: rgba(50, 50, 50, 0.9); border: 1px solid #8b0000; color: #e0e0e0; padding: 0.8rem; border-radius: 6px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button class="btn" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i> G√∂nder</button>
            </div>
        </div>
    </div>

    <!-- PROFIL -->
    <div id="userProfile" class="page">
        <div class="container">
            <button class="btn btn-secondary" onclick="showPage('home')"><i class="fas fa-arrow-left"></i> Geri</button>
            <h1 id="profileUsername" style="color: #ff9999; margin: 2rem 0;"></h1>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 2rem 0;">
                <div style="background: rgba(20, 10, 20, 0.9); border: 1px solid #8b0000; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="color: #ff9999; font-size: 1.5rem;" id="profileStoriesCount">0</div>
                    <div>Hikaye</div>
                </div>
                <div style="background: rgba(20, 10, 20, 0.9); border: 1px solid #8b0000; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="color: #ff9999; font-size: 1.5rem;" id="profileCommentsCount">0</div>
                    <div>Yorum</div>
                </div>
                <div style="background: rgba(20, 10, 20, 0.9); border: 1px solid #8b0000; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="color: #ff9999; font-size: 1.5rem;" id="profileLikesCount">0</div>
                    <div>Beƒüeni</div>
                </div>
            </div>
            <div id="profileStoriesTab"></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span onclick="toggleAuth()" style="float: right; color: #ff9999; cursor: pointer; font-size: 2rem;">&times;</span>
            <div id="loginForm">
                <h2 style="color: #ff9999; text-align: center; margin-bottom: 1.5rem;">Giri≈ü Yap</h2>
                <div class="form-group">
                    <label>Kullanƒ±cƒ± Adƒ±</label>
                    <input type="text" id="loginUsername">
                </div>
                <div class="form-group">
                    <label>≈ûifre</label>
                    <input type="password" id="loginPassword">
                </div>
                <button class="btn" style="width: 100%; margin-bottom: 1rem;" onclick="login()">Giri≈ü</button>
                <p style="text-align: center; color: #888;">Hesabƒ±n yok mu? <a href="#" onclick="switchAuthForm(); return false;" style="color: #ff9999;">Kayƒ±t ol</a></p>
            </div>
            <div id="registerForm" style="display: none;">
                <h2 style="color: #ff9999; text-align: center; margin-bottom: 1.5rem;">Kayƒ±t Ol</h2>
                <div class="form-group">
                    <label>Kullanƒ±cƒ± Adƒ±</label>
                    <input type="text" id="registerUsername">
                </div>
                <div class="form-group">
                    <label>E-posta</label>
                    <input type="email" id="registerEmail">
                </div>
                <div class="form-group">
                    <label>≈ûifre</label>
                    <input type="password" id="registerPassword">
                </div>
                <button class="btn" style="width: 100%; margin-bottom: 1rem;" onclick="register()">Kayƒ±t Ol</button>
                <p style="text-align: center; color: #888;">Zaten hesabƒ±n var mƒ±? <a href="#" onclick="switchAuthForm(); return false;" style="color: #ff9999;">Giri≈ü yap</a></p>
            </div>
        </div>
    </div>

    <div id="addStoryModal" class="modal">
        <div class="modal-content">
            <span onclick="closeAddStoryModal()" style="float: right; color: #ff9999; cursor: pointer; font-size: 2rem;">&times;</span>
            <h2 style="color: #ff9999; text-align: center; margin-bottom: 1.5rem;">Hikaye Ekle</h2>
            <div class="form-group">
                <label>Ba≈ülƒ±k</label>
                <input type="text" id="storyTitle">
            </div>
            <div class="form-group">
                <label>Kategori</label>
                <select id="storyCategory">
                    <option>Kƒ±sa Hikaye</option>
                    <option>Uzun Hikaye</option>
                    <option>√úrk√ºt√ºc√º</option>
                    <option>Gizemli</option>
                    <option>Psikiyatrik</option>
                </select>
            </div>
            <div class="form-group">
                <label>ƒ∞√ßerik</label>
                <textarea id="storyContent" rows="6"></textarea>
            </div>
            <button class="btn" style="width: 100%;" onclick="addStory()"><i class="fas fa-upload"></i> Payla≈ü</button>
        </div>
    </div>

    <footer>
        <p>¬© 2026 Korku Hikayeleri Forumu | üìß <a href="https://instagram.com/emirslmn_" style="color: #ff9999; text-decoration: none;">@emirslmn_</a> | üîó <a href="https://github.com/ermirhansalman4" style="color: #ff9999; text-decoration: none;">ermirhansalman4</a></p>
    </footer>

    <script>
        // ========== SUPABASE CONFIG ==========
        const SUPABASE_URL = 'https://zwgehkmjdhxqxblefqan.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3Z2Voa21qZGh4cXhibGVmcWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4OTg1MzgsImV4cCI6MjA4NjQ3NDUzOH0.BsIcnsERQYlYFkupxOcVgd5fwlnSjOOammjNTAxux_s';
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        let dbReady = false;

        supabase.from('stories').select('count').then(res => {
            dbReady = !res.error;
            if (dbReady) console.log('‚úÖ Supabase baƒülantƒ± ba≈üarƒ±lƒ±');
        });

        // ========== APP CLASS ==========
        class ForumApp {
            constructor() {
                this.users = JSON.parse(localStorage.getItem('users')) || [];
                if (this.users.length === 0) {
                    this.users = [
                        { username: 'admin', email: 'admin@forum.com', password: 'admin123', instagram: 'emirslmn_', github: 'ermirhansalman4' },
                        { username: 'demo', email: 'demo@test.com', password: 'demo123' }
                    ];
                }
                this.currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
                let stored = JSON.parse(localStorage.getItem('stories')) || [];
                this.allStories = stored.length > 0 ? stored : this.getInitialStories();
                this.stories = [...this.allStories];
                this.comments = JSON.parse(localStorage.getItem('comments')) || [];
                this.chatMessages = JSON.parse(localStorage.getItem('chatMessages')) || [];
                this.savedStoryIds = JSON.parse(localStorage.getItem('savedStoryIds')) || [];
                this.currentStoryId = null;
                this.init();
            }

            init() {
                this.updateUI();
                this.renderStories();
                this.listenToSupabase();
            }

            listenToSupabase() {
                if (!dbReady) return;
                supabase.from('stories').on('*', () => this.loadFromSupabase()).subscribe();
                supabase.from('comments').on('*', () => {
                    supabase.from('comments').select('*').then(({ data }) => {
                        if (data) { this.comments = data; localStorage.setItem('comments', JSON.stringify(data)); }
                    });
                }).subscribe();
            }

            async loadFromSupabase() {
                if (!dbReady) return;
                const { data } = await supabase.from('stories').select('*').order('id', { ascending: false });
                if (data) { this.allStories = data; this.stories = [...data]; this.save(); this.renderStories(); }
            }

            getInitialStories() {
                return [
                    { id: 1, title: "Eski Evin Sƒ±rrƒ±", content: "Yeni ta≈üƒ±ndƒ±ƒüƒ±m evin bodrum katƒ±nda bir oda buldum...", author: "admin", category: "Gizemli", date: new Date().toLocaleString('tr-TR'), likes: 5, liked: false },
                    { id: 2, title: "√ñdenmeyen Bor√ß", content: "Bir gece, kapƒ±ma tuhaf bir mektup i√ßeri ge√ßti...", author: "admin", category: "√úrk√ºt√ºc√º", date: new Date().toLocaleString('tr-TR'), likes: 8, liked: false },
                    { id: 3, title: "Aynada G√∂rd√ºƒü√ºm ≈ûey", content: "Sabah aynaya baktƒ±ƒüƒ±mda y√ºz√ºm√º tanƒ±madƒ±m...", author: "admin", category: "Kƒ±sa Hikaye", date: new Date().toLocaleString('tr-TR'), likes: 12, liked: false }
                ];
            }

            save() { localStorage.setItem('users', JSON.stringify(this.users)); localStorage.setItem('stories', JSON.stringify(this.allStories)); localStorage.setItem('comments', JSON.stringify(this.comments)); localStorage.setItem('currentUser', JSON.stringify(this.currentUser)); localStorage.setItem('chatMessages', JSON.stringify(this.chatMessages)); localStorage.setItem('savedStoryIds', JSON.stringify(this.savedStoryIds)); }

            updateUI() {
                const userDisplay = document.getElementById('userDisplay');
                const authBtn = document.getElementById('authBtn');
                const profileBtn = document.getElementById('profileBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                const addStoryBtn = document.getElementById('addStoryBtn');
                const libraryBtn = document.getElementById('libraryBtn');
                const chatBtn = document.getElementById('chatBtn');

                if (this.currentUser) {
                    userDisplay.textContent = `üëª ${this.currentUser.username}`;
                    authBtn.style.display = 'none';
                    profileBtn.style.display = 'block';
                    logoutBtn.style.display = 'block';
                    addStoryBtn.style.display = 'block';
                    libraryBtn.style.display = 'block';
                    chatBtn.style.display = 'block';
                } else {
                    userDisplay.textContent = '';
                    authBtn.style.display = 'block';
                    profileBtn.style.display = 'none';
                    logoutBtn.style.display = 'none';
                    addStoryBtn.style.display = 'none';
                    libraryBtn.style.display = 'none';
                    chatBtn.style.display = 'none';
                }
            }

            renderStories() {
                const container = document.getElementById('storiesContainer');
                if (!container) return;
                container.innerHTML = '';
                if (this.stories.length === 0) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888;">Hikaye bulunamadƒ±</div>';
                    return;
                }
                this.stories.forEach(story => {
                    const commentCount = this.comments.filter(c => c.storyId === story.id).length;
                    const card = document.createElement('div');
                    card.className = 'story-card';
                    const isOwner = this.currentUser && (this.currentUser.username === 'admin' || story.author === this.currentUser.username);
                    card.innerHTML = `
                        <div class="story-title">${story.title}</div>
                        <div class="story-preview">${story.content.substring(0, 150)}</div>
                        <div class="story-meta"><span>${story.author}</span> | <span>${story.date}</span></div>
                        <div class="story-actions">
                            <button class="action-btn" onclick="app.viewStory(${story.id})"><i class="fas fa-eye"></i> Oku (${commentCount})</button>
                            <button class="action-btn" onclick="app.toggleLike(${story.id})"><i class="fas fa-heart"></i> ${story.likes}</button>
                            <button class="action-btn" onclick="app.toggleSave(${story.id})"><i class="fas fa-bookmark"></i></button>
                            ${isOwner ? `<button class="action-btn" onclick="app.deleteStory(${story.id})" style="background: rgba(255, 100, 100, 0.3); color: #ff6666;"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            viewStory(id) {
                const story = this.allStories.find(s => s.id === id);
                if (!story) return;
                this.currentStoryId = id;
                document.getElementById('detailTitle').textContent = story.title;
                document.getElementById('detailAuthor').textContent = story.author;
                document.getElementById('detailDate').textContent = story.date;
                document.getElementById('detailCategory').textContent = story.category;
                document.getElementById('detailContent').textContent = story.content;
                document.getElementById('likeCount').textContent = story.likes;
                document.getElementById('commentCount').textContent = this.comments.filter(c => c.storyId === id).length;
                document.getElementById('commentForm').style.display = this.currentUser ? 'block' : 'none';
                this.renderComments(id);
                showPage('storyDetail');
            }

            renderComments(storyId) {
                const container = document.getElementById('commentContainer');
                container.innerHTML = '';
                const comments = this.comments.filter(c => c.storyId === storyId);
                if (comments.length === 0) {
                    container.innerHTML = '<p style="color: #888;">Hen√ºz yorum yok. ƒ∞lk yorumu sen yap!</p>';
                    return;
                }
                comments.forEach(c => {
                    const div = document.createElement('div');
                    div.style.cssText = 'background: rgba(100, 50, 100, 0.2); padding: 1rem; margin-bottom: 1rem; border-left: 3px solid #ff9999; border-radius: 6px;';
                    div.innerHTML = `
                        <div style="color: #ff9999; font-weight: bold;">${c.author}</div>
                        <div style="color: #d0d0d0; margin-top: 0.5rem;">${c.text}</div>
                        <div style="color: #888; font-size: 0.8rem; margin-top: 0.5rem;">${c.date}</div>
                    `;
                    container.appendChild(div);
                });
            }

            toggleLike(id) {
                const story = this.allStories.find(s => s.id === id);
                if (story) {
                    story.liked = !story.liked;
                    story.likes += story.liked ? 1 : -1;
                    if (dbReady) supabase.from('stories').update({ likes: story.likes }).eq('id', id).catch(e => console.log(e));
                    this.save();
                    this.renderStories();
                }
            }

            toggleLikeStory() {
                if (!this.currentUser) { showToast('Giri≈ü yapƒ±nƒ±z!'); return; }
                this.toggleLike(this.currentStoryId);
            }

            toggleSave(id) {
                if (!this.currentUser) { showToast('Giri≈ü yapƒ±nƒ±z!'); return; }
                const idx = this.savedStoryIds.indexOf(id);
                if (idx > -1) this.savedStoryIds.splice(idx, 1);
                else this.savedStoryIds.push(id);
                this.save();
                this.renderStories();
                this.renderLibrary();
            }

            deleteStory(id) {
                if (!this.currentUser) { showToast('Giri≈ü yapƒ±nƒ±z!'); return; }
                const story = this.allStories.find(s => s.id === id);
                if (!story || (this.currentUser.username !== 'admin' && story.author !== this.currentUser.username)) { showToast('Yetkiniz yok!'); return; }
                if (!confirm('Silmek istediƒüinize emin misiniz?')) return;
                this.allStories = this.allStories.filter(s => s.id !== id);
                this.stories = this.stories.filter(s => s.id !== id);
                this.comments = this.comments.filter(c => c.storyId !== id);
                if (dbReady) supabase.from('stories').delete().eq('id', id).catch(e => console.log(e));
                this.save();
                this.renderStories();
                showToast('Hikaye silindi!');
            }

            addNewStory(title, category, content) {
                if (!this.currentUser) { showToast('Giri≈ü yapƒ±nƒ±z!'); return false; }
                if (!title.trim() || !content.trim()) { showToast('T√ºm alanlarƒ± doldurunuz!'); return false; }
                const id = Math.max(...this.allStories.map(s => s.id), 0) + 1;
                const story = { id, title, content, author: this.currentUser.username, category, date: new Date().toLocaleString('tr-TR'), likes: 0, liked: false };
                this.allStories.unshift(story);
                this.stories.unshift(story);
                if (dbReady) supabase.from('stories').insert([story]).catch(e => console.log(e));
                this.save();
                this.renderStories();
                showToast('Hikaye payla≈üƒ±ldƒ±!');
                return true;
            }

            addNewComment(text) {
                if (!this.currentUser) { showToast('Giri≈ü yapƒ±nƒ±z!'); return false; }
                if (!text.trim()) { showToast('Yorum yazƒ±nƒ±z!'); return false; }
                const id = Math.max(...this.comments.map(c => c.id), 0) + 1;
                const comment = { id, storyId: this.currentStoryId, author: this.currentUser.username, text, date: new Date().toLocaleString('tr-TR'), likes: 0, liked: false };
                this.comments.push(comment);
                if (dbReady) supabase.from('comments').insert([comment]).catch(e => console.log(e));
                this.save();
                this.renderComments(this.currentStoryId);
                return true;
            }

            renderLibrary() {
                const container = document.getElementById('libraryContainer');
                if (!container) return;
                container.innerHTML = '';
                if (!this.currentUser) { container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #888;">Giri≈ü yapƒ±nƒ±z</p>'; return; }
                const saved = this.allStories.filter(s => this.savedStoryIds.includes(s.id));
                if (saved.length === 0) { container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #888;">Hen√ºz kaydedilen hikaye yok</p>'; return; }
                saved.forEach(story => {
                    const card = document.createElement('div');
                    card.className = 'story-card';
                    card.innerHTML = `<div class="story-title">${story.title}</div><div class="story-preview">${story.content.substring(0, 100)}</div><div class="story-actions"><button class="action-btn" onclick="app.viewStory(${story.id})"><i class="fas fa-eye"></i> Oku</button><button class="action-btn" onclick="app.toggleSave(${story.id})"><i class="fas fa-trash"></i> √áƒ±kar</button></div>`;
                    container.appendChild(card);
                });
            }

            renderChat() {
                const container = document.getElementById('chatMessages');
                if (!container) return;
                container.innerHTML = '';
                this.chatMessages.slice(-50).forEach(msg => {
                    const div = document.createElement('div');
                    div.style.cssText = 'margin-bottom: 0.5rem; padding: 0.5rem; border-left: 2px solid #ff9999;';
                    div.innerHTML = `<span style="color: #ff9999;">${msg.author}:</span> <span style="color: #d0d0d0;">${msg.text}</span><br><span style="color: #666; font-size: 0.75rem;">${msg.date}</span>`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            }

            addChatMessage(text) {
                if (!this.currentUser || !text.trim()) return;
                const msg = { id: Date.now(), author: this.currentUser.username, text: text.trim(), date: new Date().toLocaleTimeString('tr-TR') };
                this.chatMessages.push(msg);
                if (dbReady) supabase.from('chat').insert([msg]).catch(e => console.log(e));
                this.save();
                this.renderChat();
            }

            filterStories() {
                const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
                const category = document.getElementById('categoryFilter')?.value || '';
                const sort = document.getElementById('sortFilter')?.value || 'newest';
                let filtered = [...this.allStories];
                if (search) filtered = filtered.filter(s => s.title.toLowerCase().includes(search) || s.author.toLowerCase().includes(search) || s.content.toLowerCase().includes(search));
                if (category) filtered = filtered.filter(s => s.category === category);
                if (sort === 'newest') filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                else if (sort === 'popular') filtered.sort((a, b) => b.likes - a.likes);
                else if (sort === 'mostCommented') filtered.sort((a, b) => {
                    const aComments = this.comments.filter(c => c.storyId === a.id).length;
                    const bComments = this.comments.filter(c => c.storyId === b.id).length;
                    return bComments - aComments;
                });
                this.stories = filtered;
                this.renderStories();
            }

            renderUserProfile(username) {
                const stories = this.allStories.filter(s => s.author === username);
                const comments = this.comments.filter(c => c.author === username);
                let likes = 0;
                stories.forEach(s => likes += s.likes);
                comments.forEach(c => likes += c.likes);
                document.getElementById('profileUsername').textContent = username;
                document.getElementById('profileStoriesCount').textContent = stories.length;
                document.getElementById('profileCommentsCount').textContent = comments.length;
                document.getElementById('profileLikesCount').textContent = likes;
                const tab = document.getElementById('profileStoriesTab');
                tab.innerHTML = stories.map(s => `<div class="story-card" style="margin-bottom: 1rem;"><div class="story-title">${s.title}</div><div class="story-preview">${s.content.substring(0, 100)}</div><button class="action-btn" onclick="app.viewStory(${s.id})"><i class="fas fa-eye"></i> Oku</button></div>`).join('');
                showPage('userProfile');
            }
        }

        // ========== GLOBAL FUNCTIONS ==========
        const app = new ForumApp();

        function showPage(name) {
            document.querySelectorAll('.page:not(.modal)').forEach(p => p.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('addStoryModal').classList.remove('show');
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: rgba(10, 10, 10, 0.95); color: #ff9999; padding: 1rem; border: 1px solid #8b0000; border-radius: 8px; z-index: 10000;';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleAuth() { document.getElementById('authModal').classList.toggle('show'); }
        function toggleMobileMenu() { document.getElementById('mainMenu').classList.toggle('mobile-open'); }
        function showAddStoryModal() { document.getElementById('addStoryModal').classList.add('show'); }
        function closeAddStoryModal() { document.getElementById('addStoryModal').classList.remove('show'); }
        function switchAuthForm() { document.getElementById('loginForm').style.display === 'none' ? (document.getElementById('loginForm').style.display = 'block', document.getElementById('registerForm').style.display = 'none') : (document.getElementById('loginForm').style.display = 'none', document.getElementById('registerForm').style.display = 'block'); }
        
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) { showToast('T√ºm alanlarƒ± doldurunuz!'); return; }
            const user = app.users.find(u => u.username === username && u.password === password);
            if (!user) { showToast('Yanlƒ±≈ü kullanƒ±cƒ± adƒ± veya ≈üifre!'); return; }
            app.currentUser = user;
            app.save();
            app.updateUI();
            toggleAuth();
            showToast(`Ho≈ügeldiniz ${username}!`);
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            if (!username || !email || !password) { showToast('T√ºm alanlarƒ± doldurunuz!'); return; }
            if (password.length < 6) { showToast('≈ûifre en az 6 karakter olmalƒ±dƒ±r!'); return; }
            if (app.users.find(u => u.username === username)) { showToast('Bu kullanƒ±cƒ± adƒ± kullanƒ±lƒ±yor!'); return; }
            app.users.push({ username, email, password });
            app.save();
            showToast('Kayƒ±t ba≈üarƒ±lƒ±! Giri≈ü yapƒ±nƒ±z.');
            switchAuthForm();
        }

        function logout() {
            app.currentUser = null;
            app.save();
            app.updateUI();
            showPage('home');
            showToast('√áƒ±kƒ±≈ü yapƒ±ldƒ±!');
        }

        function showUserProfile() {
            if (app.currentUser) app.renderUserProfile(app.currentUser.username);
        }

        function addStory() {
            const title = document.getElementById('storyTitle').value;
            const category = document.getElementById('storyCategory').value;
            const content = document.getElementById('storyContent').value;
            if (app.addNewStory(title, category, content)) {
                document.getElementById('storyTitle').value = '';
                document.getElementById('storyContent').value = '';
                closeAddStoryModal();
            }
        }

        function addComment() {
            const text = document.getElementById('commentText').value;
            if (app.addNewComment(text)) {
                document.getElementById('commentText').value = '';
            }
        }

        function filterStories() { app.filterStories(); }
        function handleSearchInput() { app.filterStories(); }
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('sortFilter').value = 'newest';
            app.filterStories();
        }
        function setSortFilter(val) {
            document.getElementById('sortFilter').value = val;
            app.filterStories();
        }
        function sendChatMessage() {
            const text = document.getElementById('chatInput').value;
            if (text.trim()) {
                app.addChatMessage(text);
                document.getElementById('chatInput').value = '';
            }
        }
    </script>
</body>
</html>
